import json
import os

from openai import OpenAI
from dotenv import load_dotenv

load_dotenv()
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞

client = OpenAI(
    api_key=os.environ["API_TOKEN_DS"],
    base_url="https://api.deepseek.com",
)

def save_data(data: dict):
    with open("data.json", "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=4)



def get_post(posts_original: list, client_id: int):
    with open("data.json", "r", encoding="utf-8") as f:
        data = json.load(f)


    style = data[f"{client_id}"]["style"]
    history = data[f"{client_id}"]["history"]
    max_posts = data[f"{client_id}"]["max_posts"]

    if not history:
        history = [
            {
                "role": "system",
                "content": """1. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞:
        - –û—Ç—Å–µ–∏–≤–∞–π –Ω–µ–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ/—Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–æ—Ç–º–µ—á–∞–π –Ω–∏–∑–∫—É—é –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å)
        - –û–±—ä–µ–¥–∏–Ω—è–π –¥—É–±–ª–∏—Ä—É—é—â–∏–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏-–ø–æ—Å—Ç—ã, –æ—Å—Ç–∞–≤–ª—è—è –Ω–∞–∏–±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
        - –í—ã–¥–µ–ª—è–π –∫–ª—é—á–µ–≤—ã–µ —Ç–µ–∑–∏—Å—ã –∏ —Ü–∏—Ñ—Ä—ã –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π-–ø–æ—Å—Ç–æ–≤
        - –£–¥–∞–ª—è–π –Ω–æ–≤–æ—Å—Ç–∏-–ø–æ—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –∫–∞–∂—É—Ç—Å—è —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä —Ä–µ–∫–ª–∞–º–∞, —â–∏—Ç-–ø–æ—Å—Ç—ã, –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—â–∏–π —Å–º—ã—Å–ª–æ–≤–æ–π –∏ –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞)
        - –ü—Ä–æ–≤–µ—Ä—è–π –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ (—Ç.–µ. –≤—Å–µ –ø–æ—Å—Ç—ã –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞)

        2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–¥–∞—á–∏ (–Ω–∞ –∫–∞–∂–¥—ã–π –∫–µ–π—Å):
        [–ó–∞–≥–æ–ª–æ–≤–æ–∫] - –∫—Ä–∞—Ç–∫–æ, —ë–º–∫–æ, —Å —ç–º–æ–¥–∑–∏
        [–û–ø–∏—Å–∞–Ω–∏–µ] - 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å—É—Ç–∏
        [–§–∞–∫—Ç–æ—Ä—ã/–ø—Ä–∏—á–∏–Ω—ã] - –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
        [–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è] - —á–µ—Ç–∫–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
        [–ü—Ä–æ–≥–Ω–æ–∑] - –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –¥–∞–Ω–Ω—ã—Ö
        [–ò—Å—Ç–æ—á–Ω–∏–∫–∏] - @—Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª—ã (–±—É–¥—É—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω—ã –∫ –ø–æ—Å—Ç—É)

        3. –°—Ç–∏–ª–∏—Å—Ç–∏–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π):
        - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π (info): –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Ç–æ–Ω, —Ñ–∞–∫—Ç—ã, —Ü–∏—Ñ—Ä—ã
        - –¢–µ–ª–µ–≥—Ä–∞—Ñ–Ω—ã–π (telegraph): –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —Ç–æ–ª—å–∫–æ —Å—É—Ç—å
        - –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π (analytical): —Å –ø—Ä–æ–≥–Ω–æ–∑–∞–º–∏ –∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–µ–π
        - –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π (simple): –º–∏–Ω–∏–º—É–º —Ç–µ—Ä–º–∏–Ω–æ–≤, –ø–æ—è—Å–Ω–µ–Ω–∏—è
        - –ö–ª–∏–∫–±–µ–π—Ç (clickbait): —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–ø–æ –∑–∞–ø—Ä–æ—Å—É)
        - –°–≤–æ–π –≤—ã–±–æ—Ä (custom): –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –ø—Ä–∏—à–ª—ë—Ç –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∏–ª—è

        4. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (HTML –¥–ª—è Telegram):
        <b>–ó–∞–≥–æ–ª–æ–≤–∫–∏</b>
        <i>–û–ø–∏—Å–∞–Ω–∏–µ</i>
        ‚Ä¢ –°–ø–∏—Å–∫–∏
        ‚úì –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è
        [–ö—É—Ä—Å–∏–≤ –¥–ª—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤]

        5. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
        - –î–æ–±–∞–≤–ª—è–π —ç–º–æ–¥–∑–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è (–Ω–µ –±–æ–ª–µ–µ 3-4 –Ω–∞ –±–ª–æ–∫)
        - –°–æ—Ö—Ä–∞–Ω—è–π –µ–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –æ–±–∑–æ—Ä–∞
        - –î–ª—è —Ü–∏—Ñ—Ä —É–∫–∞–∑—ã–≤–∞–π –ø–µ—Ä–∏–æ–¥ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (–≥/–≥, –º/–º)
        - –û—Ç–º–µ—á–∞–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–æ–¥-–ø–æ—Å—Ç–æ–≤ (–Ω–µ –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è), –µ—Å–ª–∏ –ø–æ–¥-–ø–æ—Å—Ç–æ–≤ –º–Ω–æ–≥–æ, —Ç–æ –≤—ã–±–∏—Ä–∞–π —Ç–µ –ø–æ—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–∏–±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã

        –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ (–µ–¥–∏–Ω–∏—á–Ω–æ–≥–æ –ø–æ–¥-–ø–æ—Å—Ç–∞):
        <b>üìå –†–æ—Å—Ç –∏–Ω—Ñ–ª—è—Ü–∏–∏ –¥–æ 7.8% –≥/–≥</b>
        <i>–ü–æ –¥–∞–Ω–Ω—ã–º –†–æ—Å—Å—Ç–∞—Ç–∞ –∑–∞ –º–∞—Ä—Ç, –≥–æ–¥–æ–≤–∞—è –∏–Ω—Ñ–ª—è—Ü–∏—è —É—Å–∫–æ—Ä–∏–ª–∞—Å—å –Ω–∞ 0.5 –ø.–ø.</i>

        –û—Å–Ω–æ–≤–Ω—ã–µ –¥—Ä–∞–π–≤–µ—Ä—ã:
        ‚Ä¢ –ü—Ä–æ–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ +9.1%
        ‚Ä¢ –ù–µ–ø—Ä–æ–¥–æ–≤–æ–ª—å—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã +6.7%
        ‚Ä¢ –£—Å–ª—É–≥–∏ +5.4%"""
        }
    ]


    user_message = {
        "role": "user",
        "content": f"{[f'[–ü–û–°–¢ {i}]: {post}' for i, post in enumerate(posts_original)]}\n\n[–°–¢–ò–õ–¨: {style}]\n[–ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û–ï –ö–û–õ–ò–ß–ï–°–¢–í–û –ü–û–î-–ü–û–°–¢–û–í: {max_posts}]"
    }
    history.append(user_message)

    # –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ API
    response = client.chat.completions.create(
        model="deepseek-chat",
        messages=history,
        max_tokens=8192,
    )

    # –ü–æ–ª—É—á–∞–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç
    ai_response = response.choices[0].message.content
    history.append({"role": "assistant", "content": ai_response})

    data[f"{client_id}"]["history"] = history
    save_data(data)

    return ai_response